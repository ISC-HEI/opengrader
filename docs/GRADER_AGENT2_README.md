# OpenGrader Agent v2 - LangGraph Deep Agents Implementation

## Overview

`grader_agent2.py` is a conversational grading assistant built with LangGraph's deep agents framework. It provides a chatbot interface with agentic capabilities for grading exams.

## Key Features

- **FilesystemBackend**: Works with real files on disk
- **SQLite Checkpointing**: Persistent conversation history across sessions
- **Human-in-the-Loop**: Confirms file operations before execution
- **Skills-based Architecture**: Modular capabilities via Agent Skills
- **Gemini Integration**: Uses latest Gemini models for intelligence

## Architecture

```
grader_agent2.py (main agent)
├── FilesystemBackend (working_dir)
├── SQLite Checkpointer (opengrader.db)
└── Skills (src/skills/)
    ├── inventory/          # Scan files, validate, guide workflow
    ├── question_extraction/ # Parse exams, extract questions
    ├── pdf/                # PDF operations
    └── sql_executor/       # SQL execution (if needed)
```

## Installation

```bash
# Install dependencies
pip install deepagents langgraph google-generativeai

# Set up Gemini API key
export GOOGLE_API_KEY="your-api-key-here"
```

## Usage

### Basic Usage

```python
from src.grader_agent2 import OpenGraderAgent

# Create agent pointing to exam directory
agent = OpenGraderAgent(
    working_dir="/path/to/exam/folder"
)

# Start a grading session
response = agent.start_session(thread_id="exam_2025_sql")
print(response)

# Continue conversation
response = agent.chat("Extract questions from sql.md", thread_id="exam_2025_sql")
print(response)
```

### Command Line

```bash
# Run with default test directory
python src/grader_agent2.py

# Run with specific exam directory
python src/grader_agent2.py /path/to/exam/folder
```

### Interactive Session

```
$ python src/grader_agent2.py tests/data/exams/

OpenGrader starting in: tests/data/exams
------------------------------------------------------------
Agent: Let me scan your workspace...

[Inventory results appear]

What would you like to do next?
1. Extract questions
2. Create rubric
3. Grade without rubric

------------------------------------------------------------

You: Extract questions from sql.md

Agent: Reading sql.md...
[Extraction process with human confirmation]
✓ Successfully extracted 4 questions
Saved to: opengrader/questions.yaml
...
```

## Workflow

### 1. Inventory Phase
- Agent scans working directory
- Identifies question files, answer files, rubrics
- Validates completeness
- Presents workflow options

### 2. Question Extraction Phase
- Parses exam files (markdown, LaTeX, PDF)
- Extracts questions, solutions, metadata
- Creates structured `opengrader/questions.yaml`

### 3. Rubric Creation Phase (future)
- Guided rubric creation process
- Based on `specs/rubric_creation_process.md`
- Creates `opengrader/rubric.yaml`

### 4. Grading Phase (future)
- Grades student answers using rubric
- Generates feedback and scores
- Creates `opengrader/grades.yaml`

## File Conventions

### Working Directory Structure

```
/path/to/exam/folder/
├── sql.md              # Exam questions (teacher's file)
├── answers.json        # Student answers (teacher's file)
├── rubric.yaml         # Optional existing rubric
└── opengrader/         # Generated by OpenGrader
    ├── questions.yaml  # Extracted questions
    ├── rubric.yaml     # Generated rubric
    └── grades.yaml     # Grading results
```

### Output Format

All generated files use YAML format because:
- Human-readable
- Supports multi-line content (perfect for code/questions)
- Allows comments for documentation
- Better for version control

## Skills

### Inventory Skill
**Location**: `src/skills/inventory/SKILL.md`

Scans working directory, validates files, presents workflow options.

**When used**: Start of any grading session

### Question Extraction Skill
**Location**: `src/skills/question_extraction/SKILL.md`

Extracts questions from various formats:
- Markdown with LaTeX (`\ifsolution` blocks)
- Plain markdown
- PDF (via pdf skill)

**When used**: After inventory, before rubric creation

### PDF Skill
**Location**: `src/skills/pdf/SKILL.md`

Handles PDF operations (reading, extracting, form filling, etc.)

**When used**: When working with PDF files

## Configuration

### Custom Paths

```python
agent = OpenGraderAgent(
    working_dir="/custom/exam/folder",
    skills_dir="/custom/skills/path",
    db_path="/custom/opengrader.db",
    api_key="custom-api-key"
)
```

### Environment Variables

```bash
# Gemini API key
export GOOGLE_API_KEY="your-key"

# Optional: custom paths
export OPENGRADER_SKILLS_DIR="/custom/skills"
export OPENGRADER_DB_PATH="/custom/opengrader.db"
```

## Human-in-the-Loop

The agent confirms before:
- Writing new files
- Editing existing files
- Major operations (grading, rubric creation)

Reading files does not require confirmation.

## Thread Management

Conversations are organized by thread_id:
- Each exam/session gets a unique thread_id
- Thread history persists in SQLite
- Resume conversations by using the same thread_id

```python
# Start session
agent.start_session(thread_id="sql_exam_2025")

# Continue later (history preserved)
agent.chat("Continue grading", thread_id="sql_exam_2025")
```

## Comparison with grader_agent.py

| Feature | grader_agent.py | grader_agent2.py |
|---------|----------------|------------------|
| Framework | agent-skills-sdk | LangGraph deep agents |
| Backend | In-memory | Filesystem |
| Persistence | None | SQLite checkpointing |
| File operations | Manual | Built-in with HITL |
| Skills | Custom implementation | Standard Agent Skills |
| Status | Deprecated | Active |

## Next Steps

1. **Test the basic setup**: Run with test data
2. **Add rubric creation skill**: Based on `specs/rubric_creation_process.md`
3. **Add grading skill**: Implement actual grading logic
4. **Add answer extraction skills**: For Moodle, VPL, scans
5. **Create comprehensive tests**: Unit and integration tests

## Troubleshooting

### "Gemini API key required"
Set the `GOOGLE_API_KEY` environment variable or pass `api_key` parameter.

### "Skills directory not found"
Verify `src/skills/` exists or provide custom path via `skills_dir` parameter.

### "Database locked"
Another process is using the database. Close other instances or use a different `db_path`.

## Development

### Adding New Skills

1. Create skill directory: `src/skills/my_skill/`
2. Create `SKILL.md` with frontmatter and instructions
3. Add any supporting files (scripts, docs, etc.)
4. Reference in `SKILL.md`

### Testing

```bash
# Test with example data
python src/grader_agent2.py tests/data/exams/

# Interactive testing
python -i src/grader_agent2.py
>>> agent = OpenGraderAgent("tests/data/exams")
>>> response = agent.start_session()
```

## License

Apache 2.0 - See LICENSE.md
